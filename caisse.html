<!DOCTYPE html>
<html lang="en" style="">
<head>
    <title>My Bakey _ caisse</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="menu.css" />



</head>
<!--https://openclassrooms.com/forum/sujet/input-placer-le-curseur-automatiquement-dedans-80024-->
<body onload="document.getElementById('resultat').focus()" style="background-image: url('image/fondfinal.png'); background-size: cover">

<div class="dropdown" style="float: left; position: absolute">
    <button onclick="myFunction()" class="dropbtn" style="background-color: orange; padding:0.5em 1em 0.5em 1em; font-size: 2em; border-radius: 1em; color: #555555">MENU</button>
    <div id="myDropdown" class="dropdown-content">
        <a href="./index.html">Menu principal</a>
        <a href="./stock.html">Stock</a>
        <a href="./magasin.html">Magasin</a>
        <a href="#" id="dwn-btn">Sauvegarder ma partie</a>
        <a href="supprimer_joueur.html">Supprimer ma partie</a>
        <a href="demandeEnregistrement.html" id="seco" >Importer une partie</a>
    </div>
</div>
<script>
    var cliquer_pour_etre_aide = false;
    /* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
}

// Close the dropdown menu if the user clicks outside of it
window.onclick = function(event) {
    if (!event.target.matches('.dropbtn')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
}</script>
<div id="deco">
    <img id="porte" src="image/magasin/porte_delabree.png" style="position:absolute; top: 8em; left: 25em; width: 10em; height: 18em">
    <img id="fenetre" src="image/magasin/fenetre_delabree.png" style="position:absolute; top: 8em; left: 40em; width: 15em; height: 9em">
    <img id="fenetre_droite" src="image/magasin/fenetre_droite_delabree.png" style="position:absolute; top: 5em; right: 5em; width: 12em; height: 15em">
    <img id="table_salon" src=""     style="width: 18em; position: absolute; bottom: 5em; right: 20em; height: 12em;">
    <img id="etoile" src="" style="width: 10em; position: absolute; top: 5em; left: 5em;">
    <img id="fleur" src="" style="width: 10em; position: absolute; top: 5em; left: 15em;">
    <img id="cercle" src="" style="width: 10em; position: absolute; top: 5em; left: 25em;">
    <img id="mandala" src="" style="width: 10em; position: absolute; top: 5em; left: 35em;">
    <img id="rosace" src="" style="width: 10em; position: absolute; top: 5em; left: 45em;">
    <img id="spirale" src=""     style="width: 10em; position: absolute; top: 5em; left: 55em;">

</div>

<div style="float: left;">
    <div id="bulle" style="position: relative;right:50px; margin-top: 9em;background-color:white;text-align:center; height: 15em; padding:1em;border:2px solid #555555;border-top-right-radius:80px 40px;border-top-left-radius:80px 40px;border-bottom-right-radius:80px 40px;border-bottom-left-radius:80px 40px;margin-left: 5em;">
        <span id="output" style=" font-family: ComicFighter, Georgia; /* on spécifie une autre police standard, au cas où... */ font-weight:bold;font-size:2em;position:relative;top:26px;"></span>
        <span id="arrow_border" style="width: 0;height: 0;line-height: 0;border-bottom:0px solid transparent;border-left:30px solid transparent;border-right:30px solid #555555; /* couleur de la bordure de la bulle */position:absolute;bottom:-30px;left:65px;"></span>
        <span id="arrow_inner" style="width: 0;height: 0;line-height: 0;border-bottom:30px solid transparent;border-right:30px solid transparent;border-left:30px solid #555555; /* couleur de la bordure de la bulle */position:absolute;bottom:-25px;left:67px;"><span>
    </div>
    <img src="./image/chien.PNG" style="width: 10em; margin-left: 1em;">
    <img src="./image/caisse.png" style="width: 15em">
    <img src="./image/chat.png" style="width: 10em">
</div>
<div id="score" style="position: absolute; margin-bottom: 0.5em;right: 1em; text-shadow: -1px -1px white, 1px 1px #333;text-align: center; width: 4em; height: 1em; padding:0.5em; font-size: 3em; border-radius: 30px; background-color: orangered; text-decoration: none;""></div>
<div id="calculette" style="position:absolute;right:2em;background-color: orangered; width: 46%; top:10em; border-radius: 40px">
<span id="calcul" style="  width: 40%; text-align:left;display:none; margin: auto; margin-top: 0.5em; font-family: ComicFighter, Georgia; font-weight:bold;font-size:3em; "></span>
    <input type="text" id="resultat" autocomplete="off" placeholder="Ecris le résultat ici" style="width:90%;display: block; margin : auto;margin-top: 0.5em; margin-bottom: 0.5em;font-size: 2em; ">
<input type="submit" id="verif" style="padding:0.5em;margin:1em;margin-top: 0.2em;margin-bottom:0.5em;font-size: 2em; border-radius: 30px; background-color: coral; text-decoration: none; color: #333333; width: 8em;">
    <input type="button" id="aide" style="float:right; margin-top: 0.2em;margin-bottom:0.5em; margin-right:1em;padding:0.5em;font-size: 2em; border-radius: 30px; background-color: coral; text-decoration: none; color: #333333; width: 8em;" value="Aide" "></div>


<div>
<input type="image"  style="width: 10em" id="nb_tentatives">
</div>
<div style="position: absolute;bottom: 0px; right: 0px; display: inline-block; text-align: center">
    <span id="pieces" style="font-size: 2em"></span>
    <input type="image" src="image/sous.png" style="width: 10em; ">

</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>
    /* $.getJSON('evolution', function(data){
     console.log(data);
 });
 */
    //recuperer niveau du joueur:
    var niveau_joueur = localStorage.getItem('niveau');

    message_calcul = '';

    var liste_calculs_deja_poses
//on vérifie si la liste liste_calculs_deja_poses est vide
    if (localStorage['liste_calculs_deja_poses'] == null){
        console.log("liste_calculs_deja_poses vide");
        liste_calculs_deja_poses = []
    }
    else if (localStorage['liste_calculs_deja_poses'].length == 0){
        console.log("liste_calculs_deja_poses vide");
        liste_calculs_deja_poses = []
    }
    else {
        console.log("liste_calculs_deja_poses pas vide");
        //on récupère la liste que l'on stocke dans liste_calculs_deja_poses
        liste_calculs_deja_poses = JSON.parse(localStorage['liste_calculs_deja_poses'])
        console.log(liste_calculs_deja_poses.length)
        console.log(liste_calculs_deja_poses)
    }

    //afficher contenu json evolution en console en fonction du niveau du joueur:
    $.ajax({
        url: 'evolution',
        dataType: 'json',
        type: 'get',
        cache: false,
        success : function(data){
            $(data.evolution).each(function (index, value) {

                //on récupère la liste des produits (tupples) disponibles au niveau du joueur:
                liste_produits = value.produit;
                //console.log(liste_produits);
                //on récupère les clés (=nom de chaque produit) et leur valeur (= prix)
                keys = Object.keys(liste_produits[0]);
                values = Object.values(liste_produits[0]);
                //on calcule le nombre de produit (nombre de clés)
                nombre_produits=keys.length;
                message_client = '';
                resultat_calcul = 0;

                if (index==niveau_joueur) {
                    do {
                        if (index < 10) {
                            //console.log(keys);
                            //on sélectionne 3 produits au hasard
                            //1) on créer une liste de taille = nb produits dispos : 1, 2, 3, 4, 5...
                            //2) mélanger la liste : 2, 5, 1, 4, 3...

                            tab = new Array();
                            nom_produits = new Array();
                            prix_produits = new Array();

                            for (i = 0; i < keys.length; i++) {
                                tab[i] = i;
                                //console.log(tab[i]);
                            }
                            tab = shuffle(tab);
                            for (i = 0; i < keys.length; i++) {
                                // console.log("nb "+tab[i]);
                                nom_produits[i] = keys[tab[i]];
                                prix_produits[i] = values[tab[i]];
                                //console.log(nom_produits[i]+" "+prix_produits[i]);
                            }
                            var max;
                            if (index < 3) {
                                max = 2;
                            } else {
                                max = 3;
                            }

                            //on récupère les trois premiers produits
                            for (i = 0; i < max; i++) {
                                nom_produit = keys[tab[i]];
                                prix_produit = values[tab[i]];
                                console.log(nom_produit + " " + prix_produit);
                                //le client choisit le nombre de fois qu'il veut ce produit
                                recur_produit = Math.floor(Math.random() * (10 - 1 + 1)) + 1;
                                nom_produit = on_accorde(recur_produit, nom_produit)


                                if (i == 0) {
                                    message_client = "Bonjour, j'aimerais<br /> " + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                    message_calcul = recur_produit + " × " + prix_produit;
                                    resultat_calcul = recur_produit * prix_produit;
                                } else {
                                    message_client += ", <br />" + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                    message_calcul += "<br /> + <br />" + recur_produit + " × " + prix_produit;
                                    resultat_calcul += recur_produit * prix_produit;
                                }

                                console.log(message_client);
                                console.log(message_calcul);
                                console.log(resultat_calcul);
                            }

                        } else {
                            //console.log(keys);
                            //on sélectionne 3 produits au hasard
                            //1) on créer une liste de taille = nb produits dispos : 1, 2, 3, 4, 5...
                            //2) mélanger la liste : 2, 5, 1, 4, 3...

                            tab = new Array();
                            nom_produits = new Array();
                            prix_produits = new Array();

                            for (i = 0; i < keys.length; i++) {
                                tab[i] = i;
                                //console.log(tab[i]);
                            }
                            tab = shuffle(tab);
                            for (i = 0; i < keys.length; i++) {
                                // console.log("nb "+tab[i]);
                                nom_produits[i] = keys[tab[i]];
                                prix_produits[i] = values[tab[i]];
                                //console.log(nom_produits[i]+" "+prix_produits[i]);
                            }
                            max = 2;
                            switch (index) {
                                case 10:
                                case 11 :
                                case 12 :
                                case 13 :
                                    console.log(index);
                                    max = 2;
                                    max_recur_produit = 2;
                                    break;
                                case 14 :
                                    max = 3;
                                    max_recur_produit = 2;
                                    break;
                            }


                            //on récupère les "max" premiers produits
                            for (i = 0; i < max; i++) {
                                nom_produit = keys[tab[i]];
                                prix_produit = values[tab[i]];
                                console.log(nom_produit + " " + prix_produit);
                                recur_produit = Math.floor(Math.random() * (max_recur_produit - 1 + 1)) + 1;
                                nom_produit = on_accorde(recur_produit, nom_produit)

                                if (i == 0) {
                                    message_client = "Bonjour, j'aimerais<br /> " + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                    message_calcul = recur_produit + " × " + prix_produit;
                                    resultat_calcul = recur_produit * prix_produit;
                                } else {
                                    message_client += ", <br />" + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                    message_calcul += "<br /> + <br />" + recur_produit + " × " + prix_produit;
                                    resultat_calcul += recur_produit * prix_produit;
                                }
                                console.log(message_client);
                                console.log(message_calcul);
                                console.log(resultat_calcul);
                            }

                        }
                    }while(liste_calculs_deja_poses.includes(resultat_calcul))

                    //on enregistre le nouveau résultat dans la liste
                    liste_calculs_deja_poses[liste_calculs_deja_poses.length]=resultat_calcul
                    //on remplace la valeur de localStorage par la nouvelle liste
                    localStorage["liste_calculs_deja_poses"] = JSON.stringify(liste_calculs_deja_poses)
                    //on récupère le nouveau localstorage de liste_calculs_deja_poses
                    var new_stored_datas = JSON.parse(localStorage['liste_calculs_deja_poses'])
                    //on l'affiche
                    console.log(new_stored_datas)

                    message_client += "<br />s'il-vous-plaît.<br /> Combien je vous dois?"

                    //bulle client
                    const output = document.getElementById("output");
                    output.innerHTML += `${message_client} `;

                    //affichage calcul à faire en bas à droite
                    const calcul = document.getElementById("calcul");
                    calcul.innerHTML += `${message_calcul} =<br />`;



                    bon_resultat = resultat_calcul;
                    console.log("BON RES " + bon_resultat);

                    //vérification du résultat donné par le joueur
                    document.getElementById('verif').onclick = function (e) {
                        const resultat = document.getElementById("resultat").value;
                        if (resultat == bon_resultat) {
                            confettis()
                            bravo();
                            //alert("C'est le bon résultat, bravo!");

                            bonne_rep_test = parseInt(localStorage.getItem("bonne_reponse")) + 1;

                            if (cliquer_pour_etre_aide == true){
                                bonne_rep_test = parseInt(localStorage.getItem("bonne_reponse"));
                            }
                            if (bonne_rep_test == 3) {
                                //si c'est la 3e bonne réponse, le niveau du joueur augmente
                                niveau_joueur++;
                                localStorage.setItem("niveau", niveau_joueur);
                                console.log(localStorage.getItem("niveau"));
                                //on initialise à 0 son nb de bonne réponse et de tentative pour le nouveau niveau
                                localStorage.setItem("bonne_reponse", 0);
                                localStorage.setItem("tentative", 0);
                                pieces = parseInt(localStorage.getItem("pieces"));
                                pieces = pieces+3;
                                localStorage.setItem("pieces", pieces)
                                localStorage.setItem("liste_calculs_deja_poses", [])
                                miseEnAttente();
                               // location.reload();
                            } else {
                                //si ce n'est pas la 3e bonne réponse, on incrémente le nb de bonne réponse et initialise le nombre de tentative à 0
                                localStorage.setItem("bonne_reponse", bonne_rep_test);
                                localStorage.setItem("tentative", 0);
                                pieces = parseInt(localStorage.getItem("pieces"));
                                pieces++
                                localStorage.setItem("pieces", pieces)

                                miseEnAttente();
                               // location.reload();

                            }
                            console.log(parseInt(localStorage.getItem("bonne_reponse")) + 1);
                        } else {
                            //mauvais résultat
                            //on incrémente le nombre de tentative
                            tentative_test = parseInt(localStorage.getItem("tentative"));
                            tentative_test++;
                            console.log("tentative_test " + tentative_test);
                            //si le nb de tentatives est > 3
                            if (tentative_test > 3) {
                                //nombre de tentative dépassé, on diminue le niveau et affiche le bon résultat
                                alert("Dommage, ce n'est pas le bon résultat. Le bon résultat était " + bon_resultat);
                                // on baisse le niveau
                                if (niveau_joueur > 0) {
                                    niveau_joueur--;
                                    localStorage.setItem("niveau", niveau_joueur);
                                    localStorage.setItem("liste_calculs_deja_poses", [])
                                }
                                //on remet à 0 le nb de bonne réponse et de tentative
                                localStorage.setItem("bonne_reponse", 0);
                                localStorage.setItem("tentative", 0);
                                location.reload();
                            } else {
                                alert("Dommage, ce n'est pas le bon résultat. Essaye encore!");
                                //on incrémente le nb de tentatives
                                localStorage.setItem("tentative", tentative_test);
                                //le nombre de bonne réponse repasse à 0, car il faut 3 bonnes réponse A LA SUITE
                                localStorage.setItem("bonne_reponse", 0);
                            }
                        }
                    }

                }
            })
        }
    })

    sc = localStorage.getItem("niveau");
    const score = document.getElementById("score");
    score.innerHTML = `niveau ${sc} <br />`;

    function shuffle(array)
    {
        return array.sort(function() { return Math.random() - .5 });
    }

    nb_pieces = localStorage.getItem("pieces");
    const pieces_affichage = document.getElementById("pieces");
    if (nb_pieces > 1) {
        pieces_affichage.innerHTML = `${nb_pieces} pièces`;
    }
    else {
        pieces_affichage.innerHTML = `${nb_pieces} pièce`;
    }


    tentatives = localStorage.getItem("bonne_reponse")
console.log(tentatives)
    const te = document.getElementById("nb_tentatives");

    switch (parseInt(tentatives)) {
        case 0:
            te.src = "./image/t0.svg"
            break;
        case 1:
            te.src = "./image/t1.svg"
            break;
        case 2:
            te.src = "./image/t2.svg"
            break;


    }


</script>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
//téléchargement du fichir json avec les informations du joueur
    //https://ourcodeworld.com/articles/read/189/how-to-create-a-file-and-generate-a-download-with-javascript-in-the-browser-without-a-server
    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();
        document.body.removeChild(element);
    }
// Start file download.
document.getElementById("dwn-btn").addEventListener("click", function(){
    // Generate download of config_joueur.json file with some content
    var text = '{\n' +
        '  "prenom": "' + localStorage.getItem("prenom") +'",\n' +
        '  "niveau": "' + localStorage.getItem("niveau") +'",\n' +
        '  "tentative": "' + localStorage.getItem("tentative") +'",\n' +
        '  "bonne_reponse": "' + localStorage.getItem("bonne_reponse") +'",\n' +
        '  "pieces": "' + localStorage.getItem("pieces") +'",\n' +
        '  "liste_biens": "' + localStorage.getItem("liste_biens") +'"\n' +
        '}';
    var filename = "config_joueur.json";

    download(filename, text);
}, false);



document.getElementById("aide").addEventListener("click", function(){
    let clic_aide = document.getElementById("calcul");
    if(getComputedStyle(clic_aide).display != "none"){
        clic_aide.style.display = "none";
    } else {
        clic_aide.style.display = "block";
        cliquer_pour_etre_aide = true;
    }}, false);

function on_accorde(nb, produit){
    console.log(nb+produit)
    if (nb > 1){
        if (produit == "gateau au chocolat"){
            produit = "gateaux au chocolat"
        }
        else if (produit == "pain au chocolat"){
            produit = "pains au chocolat";
        }
        else if (produit == "charlotte aux fraises"){
            produit = "charlottes aux fraises";
        }
        else if (produit == "tarte au citron"){
            produit = "tartes au citron";
        }
        else {
            produit = produit+"s";
        }
        console.log("s:"+produit);
        return produit
    }
else {
    console.log("s:"+produit)
    return produit
    }}
</script>

<script>
    // DECO
    if (localStorage.getItem("liste_biens") == null){

    }
    else if (localStorage.getItem("liste_biens").length == 0){

    }
    else {
        liste = JSON.parse(localStorage['liste_biens'])
        var images = document.getElementsByTagName("img")
        for (i = 0 ; i < images.length ; i++){
            if (liste.includes(images[i].id)){
                document.getElementById(images[i].id).setAttribute("src", "image/magasin/"+images[i].id+".png");
            }
        }

    }

</script>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.2.0/dist/confetti.browser.min.js"></script>
<script>
    //https://www.npmjs.com/package/canvas-confetti
    // https://www.kirilv.com/canvas-confetti/

    var end = Date.now() + (15*1000);

    // go Buckeyes!
    var colors = ['#bb0000', '#ffffff'];
function confettis(){
    (function frame() {
        confetti({
            particleCount: 2,
            angle: 60,
            spread: 55,
            origin: { x: 0 },
            colors: colors
        });
        confetti({
            particleCount: 2,
            angle: 120,
            spread: 55,
            origin: { x: 1 },
            colors: colors
        });

        if (Date.now() < end) {
            requestAnimationFrame(frame);
        }
    }());}
</script>
<script>
    function miseEnAttente()
    {
        //Traitement
        setTimeout(fonctionAExecuter, 3000); //On attend 5 secondes avant d'exécuter la fonction
    }
    function fonctionAExecuter()
    {
        //Le code écrit dans cette fonction ne sera exécuté qu'au bout de 5 secondes
        location.reload()
    }
</script>


<h1 class="ml9">
  <span class="text-wrapper">
    <span class="letters"></span>
  </span>
</h1>

<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
<script>
    //https://tobiasahlin.com/moving-letters/#9
    function bravo(){


    // Wrap every letter in a span
    var textWrapper = document.querySelector('.ml9 .letters');
    textWrapper.innerHTML = "BRAVO!"
    textWrapper.innerHTML = textWrapper.textContent.replace(/\S/g, "<span class='letter'>$&</span>");

    anime.timeline({loop: true})
        .add({
            targets: '.ml9 .letter',
            scale: [0, 1],
            duration: 1500,
            elasticity: 600,
            delay: (el, i) => 45 * (i+1)
        }).add({
        targets: '.ml9',
        opacity: 0,
        duration: 1000,
        easing: "easeOutExpo",
        delay: 1000
    });}
</script>

</body>
<style>.ml9 {
    position: absolute;
    top: 50%; left: 50%;  transform: translate(-50%, -50%); /* décalage de 50% de sa propre taille */

    text-align: center;
}

.ml9 .text-wrapper {
    position: relative;
    display: inline-block;
    padding-top: 0.2em;
margin: auto;
    padding-bottom: 0.1em;
    overflow: hidden;
}

.ml9 .letter {

    transform-origin: 50% 100%;
    display: inline-block;
    line-height: 1em;
    font-size: 5em; font-weight: 1000; text-shadow: -1px -1px white, 1px 1px #333;  color: cadetblue;
}</style>
</html>