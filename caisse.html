<!DOCTYPE html>
<html lang="en">
<head>
    <title>My Bakey _ caisse</title>
    <meta charset="utf-8">

</head>
<body>
<div style="float: left;">
    <div id="bulle" style="position: relative;right:50px;background-color:white;text-align:center;/*width:500px;height:250px;*/; padding:1em;border:2px solid #555555;border-top-right-radius:80px 40px;border-top-left-radius:80px 40px;border-bottom-right-radius:80px 40px;border-bottom-left-radius:80px 40px;margin-left: 5em;">
        <span id="output" style=" font-family: ComicFighter, Georgia; /* on spécifie une autre police standard, au cas où... */ font-weight:bold;font-size:3em;position:relative;top:26px;"></span>
        <span id="arrow_border" style="width: 0;height: 0;line-height: 0;border-bottom:0px solid transparent;border-left:30px solid transparent;border-right:30px solid #555555; /* couleur de la bordure de la bulle */position:absolute;bottom:-30px;left:65px;"></span>
        <span id="arrow_inner" style="width: 0;height: 0;line-height: 0;border-bottom:30px solid transparent;border-right:30px solid transparent;border-left:30px solid #555555; /* couleur de la bordure de la bulle */position:absolute;bottom:-25px;left:67px;"></span>
    </div>
    <img src="./image/chien.PNG" style="width: 15em; margin-left: 5em;">
    <img src="./image/caisse.PNG" style="width: 20em">
    <img src="./image/chat.png" style="width: 15em">
</div>

<div style="background-color: orangered; width: 50%; float: right">
<span id="calcul" style=" display:block; margin: auto; margin-top: 0.5em; text-align: center; font-family: ComicFighter, Georgia; font-weight:bold;font-size:3em; "></span>
<input type="text" id="resultat" style="display: block; margin : auto;margin-top: 0.5em; margin-bottom: 0.5em;font-size: 3em; ">
<input type="submit" id="verif" style="display: block; margin : auto; margin-bottom:1em;font-size: 3em; ">
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script>

    /* $.getJSON('evolution', function(data){
     console.log(data);
 });
 */
    //recuperer niveau du joueur:
    var niveau_joueur = localStorage.getItem('niveau');

    //afficher contenu json evolution en console en fonction du niveau du joueur:
    $.ajax({
        url: 'evolution',
        dataType: 'json',
        type: 'get',
        cache: false,
        success : function(data){
            $(data.evolution).each(function (index, value) {
                //on récupère la liste des produits (tupples) disponibles au niveau du joueur:
                liste_produits = value.produit;
                //console.log(liste_produits);
                //on récupère les clés (=nom de chaque produit) et leur valeur (= prix)
                keys = Object.keys(liste_produits[0]);
                values = Object.values(liste_produits[0]);
                //on calcule le nombre de produit (nombre de clés)
                nombre_produits=keys.length;
                message_client = '';
                message_calcul = '';
                resultat_calcul = 0;

                if (index==4) {
                    if (index <= 3){
                        for (i = 0; i <= index ; i++){
                            nom_produit = keys[i];
                            prix_produit = values[i];
                            //le client choisit le nombre de fois qu'il veut ce produit
                            recur_produit = Math.floor(Math.random() * (3 - 1 + 1)) + 1;

                            if (i == 0){
                                message_client = "Bonjour, j'aimerais " + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul = recur_produit + "*" + prix_produit;
                                resultat_calcul = recur_produit * prix_produit;
                            }
                            else {
                                message_client += ", <br />" + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul += "<br /> + <br />" + recur_produit + "*" + prix_produit;
                                resultat_calcul += recur_produit * prix_produit;
                            }
                            console.log(message_client);
                            console.log(message_calcul);
                            console.log(resultat_calcul);
                        }
                    }
                    else{
                        //on choisi 3 produits parmis tous ceux dispos
                        var tab=new Array();
                        for (j = 0; j <= nombre_produits; j++){
                            tab[j]=j;
                            console.log(tab[j]);
                        }
                        tab = shuffle(tab);
                        for (j = 0; j <= nombre_produits; j++){
                            console.log(tab[j])
                        }
                        for (i = 0; i <= 3 ; i++){
                            nom_produit = keys[tab[i]];
                            prix_produit = values[tab[i]];
                            console.log(nom_produit+" "+prix_produit);
                            //le client choisit le nombre de fois qu'il veut ce produit
                            recur_produit = Math.floor(Math.random() * (10 - 1 + 1)) + 1;

                            if (i == 0){
                                message_client = "Bonjour, j'aimerais " + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul = recur_produit + "*" + prix_produit;
                                resultat_calcul = recur_produit * prix_produit;
                            }
                            else {
                                message_client += ", <br />" + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul += "<br /> + <br />" + recur_produit + "*" + prix_produit;
                                resultat_calcul += recur_produit * prix_produit;
                            }
                            console.log(message_client);
                            console.log(message_calcul);
                            console.log(resultat_calcul);
                        }

                    }

                    message_client += "<br />S'il-vous-plaît."

                    //bulle client
                    const output = document.getElementById("output");
                    output.innerHTML += `${message_client} `;

                    //affichage calcul à faire en bas à droite
                    const calcul = document.getElementById("calcul");
                    calcul.innerHTML += `${message_calcul} =<br />`;
                }







                if (index!=index){
                    /*console.log(index);
                    console.log(data);
                    console.log(value.produit);
                    console.log(value.produit.length);*/

                    //on récupère la liste des produits (tupples) disponibles au niveau du joueur:
                    liste_produits = value.produit;
                    //console.log(liste_produits);
                    //on récupère les clés (=nom de chaque produit)
                    keys = Object.keys(liste_produits[0]);
                    //on calcule le nombre de produit (nombre de clés)
                    nombre_produits=keys.length;
                    // console.log(nombre_produits);
                    //on choisit un entier au hasard parmis le nombre de produit
                    nb_random =     Math.floor(Math.random() * Math.floor(nombre_produits));
                    // console.log(nb_random);
                    //on affiche la clé (=nom produit)
                    nom_produit = keys[nb_random];
                    console.log(nom_produit);
                    //on affiche la valeur de la clé (=prix produit)
                    values = Object.values(liste_produits[0]);
                    prix_produit = values[nb_random];
                    console.log(prix_produit);

                    //le client choisit le nombre de fois qu'il veut ce produit
                    recur_produit =     Math.floor(Math.random() * (3 - 1 + 1)) + 1;

                    //bulle client
                    const output = document.getElementById("output");
                    output.innerHTML += `Bonjour, ${recur_produit} ${nom_produit} s'il-vous-plaît<br />`;

                    //affichage calcul à faire en bas à droite
                    const calcul = document.getElementById("calcul");
                    calcul.innerHTML += `${recur_produit} * ${prix_produit} =<br />`;

                    //calcul du résultat attendu
                    bon_resultat = recur_produit * prix_produit;

                    //vérification du résultat donné par le joueur
                    document.getElementById('verif').onclick = function(e) {
                        const resultat = document.getElementById("resultat").value;
                        if(resultat==bon_resultat){

                            alert("C'est le bon résultat, bravo!");
                            bonne_rep_test = parseInt(localStorage.getItem("bonne_reponse"))+1;
                            if (bonne_rep_test == 3){
                                //si c'est la 3e bonne réponse, le niveau du joueur augmente
                                localStorage.setItem("niveau", parseInt(localStorage.getItem("niveau")+1));
                                console.log(localStorage.getItem("niveau"));
                                //on initialise à 0 son nb de bonne réponse et de tentative pour le nouveau niveau
                                localStorage.setItem("bonne_reponse", 0);
                                localStorage.setItem("tentative", 0);
                                location.reload();
                            }
                            else {
                                //si ce n'est pas la 3e bonne réponse, on incrémente le nb de bonne réponse et initialise le nombre de tentative à 0
                                localStorage.setItem("bonne_reponse", bonne_rep_test);
                                localStorage.setItem("tentative", 0);
                                location.reload();

                            }
                            console.log(parseInt(localStorage.getItem("bonne_reponse"))+1);
                        } else{
                            //mauvais résultat
                            //on incrémente le nombre de tentative
                            tentative_test = parseInt(localStorage.getItem("tentative"));
                            tentative_test++;
                            console.log("tentative_test " + tentative_test);
                            //si le nb de tentatives est > 3
                            if (tentative_test > 3){
                                //nombre de tentative dépassé, on diminue le niveau et affiche le bon résultat
                                alert("Dommage, ce n'est pas le bon résultat. " + recur_produit + " * " + prix_produit + " = " + bon_resultat);
                                // on baisse le niveau
                                if (niveau_joueur>0){
                                    niveau_joueur--;
                                    localStorage.setItem("niveau", niveau_joueur);
                                }
                                //on remet à 0 le nb de bonne réponse et de tentative
                                localStorage.setItem("bonne_reponse", 0);
                                localStorage.setItem("tentative", 0);
                                location.reload();
                            }
                            else{
                                alert("Dommage, ce n'est pas le bon résultat. Essaye encore!");
                                //on incrémente le nb de tentatives
                                localStorage.setItem("tentative", tentative_test);
                                //le nombre de bonne réponse repasse à 0, car il faut 3 bonnes réponse A LA SUITE
                                localStorage.setItem("bonne_reponse", 0);
                            }
                        }      }

                }
            })
        }
    })

    function shuffle(array)
    {
        return array.sort(function() { return Math.random() - .5 });
    }
</script>
</body>
</html>