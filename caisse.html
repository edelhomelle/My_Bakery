<!DOCTYPE html>
<html lang="en">
<head>
    <title>My Bakey _ caisse</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="menu.css" />



</head>
<body>
<div class="dropdown">
    <button onclick="myFunction()" class="dropbtn">Menu</button>
    <div id="myDropdown" class="dropdown-content">
        <a href="./index.html">Menu principal</a>
        <a href="./stock.html">Stock</a>
        <a href="#" id="dwn-btn">Sauvegarder ma partie</a>
        <a href="#" id="supprimer_joueur">Supprimer ma partie</a>
    </div>
</div>
<script>
    var cliquer_pour_etre_aide = false;
    /* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
}

// Close the dropdown menu if the user clicks outside of it
window.onclick = function(event) {
    if (!event.target.matches('.dropbtn')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
}</script>
<div style="float: left;">
    <div id="bulle" style="position: relative;right:50px; margin-top: 9em;background-color:white;text-align:center; height: 15em; padding:1em;border:2px solid #555555;border-top-right-radius:80px 40px;border-top-left-radius:80px 40px;border-bottom-right-radius:80px 40px;border-bottom-left-radius:80px 40px;margin-left: 5em;">
        <span id="output" style=" font-family: ComicFighter, Georgia; /* on spécifie une autre police standard, au cas où... */ font-weight:bold;font-size:2em;position:relative;top:26px;"></span>
        <span id="arrow_border" style="width: 0;height: 0;line-height: 0;border-bottom:0px solid transparent;border-left:30px solid transparent;border-right:30px solid #555555; /* couleur de la bordure de la bulle */position:absolute;bottom:-30px;left:65px;"></span>
        <span id="arrow_inner" style="width: 0;height: 0;line-height: 0;border-bottom:30px solid transparent;border-right:30px solid transparent;border-left:30px solid #555555; /* couleur de la bordure de la bulle */position:absolute;bottom:-25px;left:67px;"><span>
    </div>
    <img src="./image/chien.PNG" style="width: 10em; margin-left: 1em;">
    <img src="./image/caisse.PNG" style="width: 15em">
    <img src="./image/chat.png" style="width: 10em">
</div>
<div id="score" style=" margin-bottom: 0.5em;float: right; text-shadow: -1px -1px white, 1px 1px #333;text-align: center; width: 1em; height: 1em; padding:0.5em; font-size: 3em; border-radius: 30px; background-color: orangered; text-decoration: none; color: #333333""></div>
<div id="calculette" style="background-color: orangered; width: 50%; float: right">
<span id="calcul" style="  display:none; margin: auto; margin-top: 0.5em; text-align: center; font-family: ComicFighter, Georgia; font-weight:bold;font-size:3em; "></span>
<input type="text" id="resultat" style="display: block; margin : auto;margin-top: 0.5em; margin-bottom: 0.5em;font-size: 3em; ">
<input type="submit" id="verif" style="padding:0.5em;margin:1em;margin-top: 0.2em;margin-bottom:0.5em;font-size: 2em; border-radius: 30px; background-color: coral; text-decoration: none; color: #333333; width: 8em;">
    <input type="button" id="aide" style="float:right; margin:1em;margin-top: 0.2em;margin-bottom:0.5em;padding:0.5em;font-size: 2em; border-radius: 30px; background-color: coral; text-decoration: none; color: #333333; width: 8em;" value="Aide" "></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>
    /* $.getJSON('evolution', function(data){
     console.log(data);
 });
 */
    //recuperer niveau du joueur:
    var niveau_joueur = localStorage.getItem('niveau');
    message_calcul = '';

    //afficher contenu json evolution en console en fonction du niveau du joueur:
    $.ajax({
        url: 'evolution',
        dataType: 'json',
        type: 'get',
        cache: false,
        success : function(data){
            $(data.evolution).each(function (index, value) {
                //on récupère la liste des produits (tupples) disponibles au niveau du joueur:
                liste_produits = value.produit;
                //console.log(liste_produits);
                //on récupère les clés (=nom de chaque produit) et leur valeur (= prix)
                keys = Object.keys(liste_produits[0]);
                values = Object.values(liste_produits[0]);
                //on calcule le nombre de produit (nombre de clés)
                nombre_produits=keys.length;
                message_client = '';
                resultat_calcul = 0;

                if (index==niveau_joueur) {
                    if (index < 3) {
                        for (i = 0; i <= index; i++) {

                            nom_produit = keys[i];
                            prix_produit = values[i];
                            //le client choisit le nombre de fois qu'il veut ce produit
                            recur_produit = Math.floor(Math.random() * (3 - 1 + 1)) + 1;

                            if (i == 0) {
                                message_client = "Bonjour, <br />J'aimerais " + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul = recur_produit + "*" + prix_produit;
                                resultat_calcul = recur_produit * prix_produit;
                            } else {
                                message_client += ", <br />" + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul += "<br /> + <br />" + recur_produit + "*" + prix_produit;
                                resultat_calcul += recur_produit * prix_produit;
                            }
                            console.log(message_client);
                            console.log(message_calcul);
                            console.log(resultat_calcul);
                        }
                    } else if (index < 5) {
                        //console.log(keys);
                        //on sélectionne 3 produits au hasard
                        //1) on créer une liste de taille = nb produits dispos : 1, 2, 3, 4, 5...
                        //2) mélanger la liste : 2, 5, 1, 4, 3...

                        tab = new Array();
                        nom_produits = new Array();
                        prix_produits = new Array();

                        for (i = 0; i < keys.length; i++) {
                            tab[i] = i;
                            //console.log(tab[i]);
                        }
                        tab = shuffle(tab);
                        for (i = 0; i < keys.length; i++) {
                            // console.log("nb "+tab[i]);
                            nom_produits[i] = keys[tab[i]];
                            prix_produits[i] = values[tab[i]];
                            //console.log(nom_produits[i]+" "+prix_produits[i]);
                        }

                        //on récupère les trois premiers produits
                        for (i = 0; i < 3; i++) {
                            nom_produit = keys[tab[i]];
                            prix_produit = values[tab[i]];
                            console.log(nom_produit + " " + prix_produit);
                            //le client choisit le nombre de fois qu'il veut ce produit
                            recur_produit = Math.floor(Math.random() * (10 - 1 + 1)) + 1;

                            if (i == 0) {
                                message_client = "Bonjour, <br />j'aimerais " + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul = recur_produit + "*" + prix_produit;
                                resultat_calcul = recur_produit * prix_produit;
                            } else {
                                message_client += ", <br />" + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul += "<br /> + <br />" + recur_produit + "*" + prix_produit;
                                resultat_calcul += recur_produit * prix_produit;
                            }
                            console.log(message_client);
                            console.log(message_calcul);
                            console.log(resultat_calcul);
                        }

                    } else {
                        //console.log(keys);
                        //on sélectionne 3 produits au hasard
                        //1) on créer une liste de taille = nb produits dispos : 1, 2, 3, 4, 5...
                        //2) mélanger la liste : 2, 5, 1, 4, 3...

                        tab = new Array();
                        nom_produits = new Array();
                        prix_produits = new Array();

                        for (i = 0; i < keys.length; i++) {
                            tab[i] = i;
                            //console.log(tab[i]);
                        }
                        tab = shuffle(tab);
                        for (i = 0; i < keys.length; i++) {
                            // console.log("nb "+tab[i]);
                            nom_produits[i] = keys[tab[i]];
                            prix_produits[i] = values[tab[i]];
                            //console.log(nom_produits[i]+" "+prix_produits[i]);
                        }
                        max = 3;
                        switch (index) {
                            case 5:
                                max = 2;
                                recur_produit = 1;
                                break;
                            case 6 :
                                max = 3;
                                recur_produit = 1;
                                break;
                            case 7 :
                                max = 2;
                                recur_produit = Math.floor(Math.random() * (2 - 1 + 1)) + 1;
                                break;
                            case 8 :
                                max = 3;
                                recur_produit = Math.floor(Math.random() * (2 - 1 + 1)) + 1;
                                break;
                        }

                        //on récupère les "max" premiers produits
                        for (i = 0; i < max; i++) {
                            nom_produit = keys[tab[i]];
                            prix_produit = values[tab[i]];
                            console.log(nom_produit + " " + prix_produit);

                            if (i == 0) {
                                message_client = "Bonjour, <br />j'aimerais " + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul = recur_produit + "*" + prix_produit;
                                resultat_calcul = recur_produit * prix_produit;
                            } else {
                                message_client += ", <br />" + recur_produit + " " + nom_produit + " (" + prix_produit + "€)";
                                message_calcul += "<br /> + <br />" + recur_produit + "*" + prix_produit;
                                resultat_calcul += recur_produit * prix_produit;
                            }
                            console.log(message_client);
                            console.log(message_calcul);
                            console.log(resultat_calcul);
                        }

                    }

                    message_client += "<br />S'il-vous-plaît.<br /> Combien je vous dois?"

                    //bulle client
                    const output = document.getElementById("output");
                    output.innerHTML += `${message_client} `;

                    //affichage calcul à faire en bas à droite
                    const calcul = document.getElementById("calcul");
                    calcul.innerHTML += `${message_calcul} =<br />`;



                    bon_resultat = resultat_calcul;
                    console.log("BON RES " + bon_resultat);

                    //vérification du résultat donné par le joueur
                    document.getElementById('verif').onclick = function (e) {
                        const resultat = document.getElementById("resultat").value;
                        if (resultat == bon_resultat) {

                            alert("C'est le bon résultat, bravo!");
                            bonne_rep_test = parseInt(localStorage.getItem("bonne_reponse")) + 1;

                            if (cliquer_pour_etre_aide == true){
                                bonne_rep_test = parseInt(localStorage.getItem("bonne_reponse"));
                            }
                            if (bonne_rep_test == 3) {
                                //si c'est la 3e bonne réponse, le niveau du joueur augmente
                                niveau_joueur++;
                                localStorage.setItem("niveau", niveau_joueur);
                                console.log(localStorage.getItem("niveau"));
                                //on initialise à 0 son nb de bonne réponse et de tentative pour le nouveau niveau
                                localStorage.setItem("bonne_reponse", 0);
                                localStorage.setItem("tentative", 0);
                                location.reload();
                            } else {
                                //si ce n'est pas la 3e bonne réponse, on incrémente le nb de bonne réponse et initialise le nombre de tentative à 0
                                localStorage.setItem("bonne_reponse", bonne_rep_test);
                                localStorage.setItem("tentative", 0);
                                location.reload();

                            }
                            console.log(parseInt(localStorage.getItem("bonne_reponse")) + 1);
                        } else {
                            //mauvais résultat
                            //on incrémente le nombre de tentative
                            tentative_test = parseInt(localStorage.getItem("tentative"));
                            tentative_test++;
                            console.log("tentative_test " + tentative_test);
                            //si le nb de tentatives est > 3
                            if (tentative_test > 3) {
                                //nombre de tentative dépassé, on diminue le niveau et affiche le bon résultat
                                alert("Dommage, ce n'est pas le bon résultat. Le bon résultat était " + bon_resultat);
                                // on baisse le niveau
                                if (niveau_joueur > 0) {
                                    niveau_joueur--;
                                    localStorage.setItem("niveau", niveau_joueur);
                                }
                                //on remet à 0 le nb de bonne réponse et de tentative
                                localStorage.setItem("bonne_reponse", 0);
                                localStorage.setItem("tentative", 0);
                                location.reload();
                            } else {
                                alert("Dommage, ce n'est pas le bon résultat. Essaye encore!");
                                //on incrémente le nb de tentatives
                                localStorage.setItem("tentative", tentative_test);
                                //le nombre de bonne réponse repasse à 0, car il faut 3 bonnes réponse A LA SUITE
                                localStorage.setItem("bonne_reponse", 0);
                            }
                        }
                    }

                }
            })
        }
    })

    sc = localStorage.getItem("niveau");
    const score = document.getElementById("score");
    score.innerHTML = `${sc} <br />`;

    function shuffle(array)
    {
        return array.sort(function() { return Math.random() - .5 });
    }

</script>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
//téléchargement du fichir json avec les informations du joueur
    //https://ourcodeworld.com/articles/read/189/how-to-create-a-file-and-generate-a-download-with-javascript-in-the-browser-without-a-server
    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();
        document.body.removeChild(element);
    }
// Start file download.
document.getElementById("dwn-btn").addEventListener("click", function(){
    // Generate download of config_joueur.json file with some content
    var text = '{\n' +
        '  "prenom": "' + localStorage.getItem("prenom") +'",\n' +
        '  "niveau": "' + localStorage.getItem("niveau") +'",\n' +
        '  "tentative": "' + localStorage.getItem("tentative") +'",\n' +
        '  "bonne_reponse": "' + localStorage.getItem("bonne_reponse") +'"\n' +
        '}';
    var filename = "config_joueur.json";

    download(filename, text);
}, false);

document.getElementById("dwn-btn").addEventListener("click", function(){
    localStorage.clear();
}, false);

document.getElementById("aide").addEventListener("click", function(){
    let clic_aide = document.getElementById("calcul");
    if(getComputedStyle(clic_aide).display != "none"){
        clic_aide.style.display = "none";
    } else {
        clic_aide.style.display = "block";
        cliquer_pour_etre_aide = true;
    }}, false);

</script>

</body>
</html>